{% extends 'common/base.html' %}
{% load static %}

{% block content %}
<style>
  body { background-color: #f7fafd; }
  .btn-create { margin-bottom: 20px; }
</style>

<!-- ✅ DataTables CSS -->
<link rel="stylesheet" 
  href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<div class="container mt-4">
  <div class="row">
    
    <!-- Sidebar -->
    <div class="col-md-3">
      {% include 'vtc/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
      <h2 class="mb-4">Scheduled Trainings</h2>
      
      {% if trainings %}
          <table id="trainingsTable" class="table table-bordered table-striped">
            <thead class="table-primary">
              <tr>
                <th>S.No.</th>
                <th>Worker Name</th>
                <th>From Date</th>
                <th>To Date</th>
                <th>VTC Status</th>
                <th>Attendance / Result</th>
                <th style="display:none;">SortCert</th> <!-- hidden sort col -->
                <th>Download Certificate</th>
              </tr>
            </thead>
            <tbody>
              {% for training in trainings %}
              <tr data-status="{{ training.vtc_status }}">
                <td>{{ forloop.counter }}</td>
                <td>{{ training.worker.name }}</td>
                <td>{{ training.from_date }}</td>
                <td>{{ training.to_date }}</td>
                <td>
                  {% if training.vtc_status == 'approved' %}
                    ✅ Approved
                  {% else %}
                    ⏳ Pending
                  {% endif %}
                </td>
                <td>
                  {% if training.vtc_status == 'approved' %}
                    <a href="{% url 'vtc:add_training_attendance_and_result' training.pk %}" 
                      class="btn btn-info btn-sm btn-action">
                      View Attendance & Result
                    </a>
                  {% else %}
                    <a href="{% url 'vtc:add_training_attendance_and_result' training.pk %}" 
                      class="btn btn-primary btn-sm btn-action">
                      Mark Attendance & Result
                    </a>
                  {% endif %}
                </td>

                <!-- Hidden numeric column for certificate sorting -->
                <td style="display:none;">
                  {% if training.mm_status != 'approved' %}
                    1
                  {% elif training.mm_status == 'approved' and not training.certificate_serial_number %}
                    2
                  {% else %}
                    3
                  {% endif %}
                </td>

                <!-- Visible certificate action -->
                <td>
                  {% if training.mm_status == 'approved' %}
                    {% if training.certificate_serial_number %}
                      <a href="{% url 'mm:generate_form_a_pdf' training.pk %}" class="btn btn-success btn-sm" target="_blank">
                        Download Certificate
                      </a>
                    {% else %}
                      <a href="{% url 'mm:generate_form_a_pdf' training.pk %}" class="btn btn-primary btn-sm" target="_blank">
                        Generate Certificate
                      </a>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">Not Approved</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
      {% else %}
          <div class="alert alert-warning text-center" role="alert">
            No scheduled trainings found.
          </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- ✅ jQuery + DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- ✅ DataTables Initialization with Custom Sorting -->
<script>
$(document).ready(function() {
  let table = $('#trainingsTable').DataTable({
    "order": [[6, 'asc']],  // sort by hidden SortCert column
    "pageLength": 10,
    "columnDefs": [
      { "orderable": false, "targets": [0, 5, 7] }, // disable sort on S.No, Attendance/Result, Certificate
      { "visible": false, "targets": [6] }          // hide SortCert column
    ]
  });

  // ✅ Replace status text with sortable span
  table.rows().every(function() {
    let status = $(this.node()).data('status');
    let displayText = status === "approved" ? "✅ Approved" : "⏳ Pending";
    let sortValue = status === "approved" ? "1" : "0";
    this.cell(this.index(), 4).data(`<span data-order="${sortValue}">${displayText}</span>`);
  });
});
</script>

{% endblock %}
